<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="google-site-verification" content="LYZAMZyp5IGDHDRhRMjN0VoDglk1rEoj9nYv62BRxfQ" />
        <title>snow-dev.com :: Creating your own PHP dev-env in Vagrant: Part 2</title>
        <link rel="stylesheet" href="../css/default.css" />
        <link rel="stylesheet" href="../css/syntax.css" />
        <link rel="stylesheet" href="../css/fontawesome.min.css">
        <link rel="stylesheet" href="../css/fontawesome-solid.min.css">
        <link rel="stylesheet" href="../css/fontawesome-brands.min.css">
    </head>
    <body>
        <header>
            <div class="logo">
                <a href="../">snow-dev.com</a>
            </div>
            <nav>
                <a href="../" title="Home"><i class="fas fa-home"></i></a>
                <a href="../about.html" title="About"><i class="fas fa-info"></i></a>
                <a href="../archive.html" title="Archive"><i class="fas fa-archive"></i></a>
                <a href="../atom.xml" title="Atom Feed"><i class="fas fa-atom"></i></a>
                <a href="../rss.xml" title="RSS Feed"><i class="fas fa-rss"></i></a>
                <a href="https://github.com/snowiow" title="Github"><i class="fab fa-github"></i></a>
                <a href="mailto:marcel.patzwahl@posteo.de" title="Contact Me"><i class="fas fa-envelope"></i></a>
            </nav>
        </header>
          <main role="main">
              <h1>Creating your own PHP dev-env in Vagrant: Part 2</h1>
              <article>
    <section class="header">
        Posted on 2016-06-03
    </section>
    <hr class="section-head">
    <section>
        <h1 id="table-of-contents">Table of Contents</h1>
<ul>
<li><a href="../posts/creating-your-own-php-dev-env-in-vagrant.html">Part 1</a></li>
<li><a href="../posts/creating-your-own-php-dev-env-in-vagrant-part-3.html">Part 3</a></li>
<li><a href="../posts/creating-your-own-php-dev-env-in-vagrant-bonus-1.html">Bonus 1</a></li>
<li><a href="../posts/creating-your-own-php-dev-env-in-vagrant-bonus-2.html">Bonus 2</a></li>
<li><a href="https://github.com/snowiow/vagrant-template">Full Code Base on GitHub</a></li>
</ul>
<p>In the last post we installed vagrant and enabled the vagrant settings we need in the Vagrantfile. We have set a base image of ubuntu 14.04, made a synced folder and enabled a private network connection between host and guest system. Now it’s time to write our first shell scripts, which will configure our guest system to serve as a web server. Vagrant comes with a neat feature called provisioning. This can be shell scripts, which will be executed or files, which will be uploaded onto the guest system. Of course there are more provisioners to explore. For a full reference head over <a href="https://www.vagrantup.com/docs/provisioning/">here</a>. In this tutorial we will focus on these two provisioners. Before we setup our apache webserver, let’s start with a simple script, which should run before. This script will update the ubuntu system and should be a great intro into provisioning. First we create a new directory inside of our vagrant directory, called <strong>sh</strong>. This directory will contain all of our shell scripts, which we will write during this tutorial. Everything could be in a single shell script, but I like to split the shell scripts into specific categories. The first will be called <em>update.sh</em> and contains the the following content:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">#!/usr/bin/env bash</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="ex">apt-get</span> update</a></code></pre></div>
<p>The first line will be in every script we write. It’s a dynamic binding to tell the operating system where to find the program, which should execute this script. Afterwards we update the system by executing <em>apt-get update</em>. As you can see, we don’t need to issue <em>sudo</em> rights. Everything inside these shell scripts will be run as a super user automagically. Now we need to get vagrant to provision this file. That’s why we add the following line after the definition of our base system.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb2-1" data-line-number="1">config.vm.box = <span class="st">&quot;ubuntu/trusty64&quot;</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">config.vm.provision <span class="st">&quot;shell&quot;</span>, <span class="st">path: &quot;sh/update.sh&quot;</span></a></code></pre></div>
<p>This statement is pretty straight forward. We tell vagrant that we want to provision something, which is of the type <em>shell</em> and the path to the shell script is <em>sh/update.sh</em>. If we would start our system now, it would do a system update at the beginning. Now that we are working on the latest state of the system, we can start adding new software. It’s time to create the apache webserver. We add a new filed called <em>apache.sh</em> to the sh directory, which we created earlier. We start off in the same way, by downloading the software via apt-get:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="ex">apt-get</span> install -y apache2</a></code></pre></div>
<p>Followed by this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">if</span> !<span class="bu"> [</span> <span class="ot">-L</span> /var/www/html<span class="bu"> ]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    <span class="fu">rm</span> -rf /var/www/html</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="fu">ln</span> -fs /vagrant/projects /var/www/html</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">fi</span></a></code></pre></div>
<p>Here we delete any symlinks on the <em>/var/www/html</em> location, if they exist and create a new one afterwards. The symlink will be between our projects directory and the apache web server. So everything which changes in one place, will automatically change in the other location as well. It’s like the synced folders, but it’s an inter system feature of linux. The next part is optional. I copied the whole <em>apache.conf</em> out of it’s base installation and keep it on my host system to change some things. On system startup I copy it back onto the guest and replace the base config with it.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">if</span><span class="bu"> [</span> <span class="ot">-f</span> /vagrant/tmp/apache2.conf<span class="bu"> ]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">    <span class="fu">mv</span> /vagrant/tmp/apache2.conf /etc/apache2/apache2.conf</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">else</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="op">&gt;&amp;2</span> <span class="bu">echo</span> <span class="st">&quot;Error: apache2.conf not found&quot;</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw">fi</span></a></code></pre></div>
<p>This is a check, if a file is in the <em>vagrant/tmp</em> directory, called <em>apache2.conf</em>. If there is one, it will be moved over to the position of the original file. Otherwise an error is printed to the error channel of the console. But how do we get the file to the <em>tmp</em> directory? Remember that shell provision isn’t the only thing? Because now file provisioning comes into play.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb6-1" data-line-number="1">config.vm.provision <span class="st">&quot;file&quot;</span>, <span class="st">source: &quot;conf/apache2.conf&quot;</span>, <span class="st">destination: &quot;/vagrant/tmp/apache2.conf&quot;</span></a></code></pre></div>
<p>We add this line under the shell provision. This copies the file from the <em>conf</em> directory to the <em>tmp</em> directory of the guest system. Why we need to do this extras step, you may ask? Why not copy it directly to the original location? Well, it’s pretty simple: In the provision context you don’t have any root rights. But later in the shell script you do. That’s why we provide a place for our files, where the shell scripts have access to later. The next thing I do, is changing the rights on the webspace and the log directory, to be able to create and read files without any problems.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="fu">chmod</span> -R 755 /var/www</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="fu">chmod</span> -R 755 /var/log</a></code></pre></div>
<p>The last thing I do is activating mod rewrite, which allows web applications to rewrite the routing of requests. Many frameworks rely heavily on this feature.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="ex">a2enmod</span> rewrite</a></code></pre></div>
<p>And this is our full <em>apache2.sh</em> script:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co">#!/usr/bin/env bash</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="ex">apt-get</span> install -y apache2</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#Symlink the apache webspace to the shared folder of the host and guest syste,</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="kw">if</span> !<span class="bu"> [</span> <span class="ot">-L</span> /var/www/html<span class="bu"> ]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">    <span class="fu">rm</span> -rf /var/www/html</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">    <span class="fu">ln</span> -fs /vagrant/projects /var/www/html</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="kw">fi</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#Copy the apache2.conf to the right location</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="kw">if</span><span class="bu"> [</span> <span class="ot">-f</span> /vagrant/tmp/apache2.conf<span class="bu"> ]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">    <span class="fu">mv</span> /vagrant/tmp/apache2.conf /etc/apache2/apache2.conf</a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="kw">else</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15">    <span class="op">&gt;&amp;2</span> <span class="bu">echo</span> <span class="st">&quot;Error: apache2.conf not found&quot;</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="kw">fi</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"></a>
<a class="sourceLine" id="cb9-18" data-line-number="18"><span class="co">#grant permission to webserver</span></a>
<a class="sourceLine" id="cb9-19" data-line-number="19"><span class="fu">chmod</span> -R 777 /var/www</a>
<a class="sourceLine" id="cb9-20" data-line-number="20"><span class="fu">chmod</span> -R 777 /var/log</a>
<a class="sourceLine" id="cb9-21" data-line-number="21"></a>
<a class="sourceLine" id="cb9-22" data-line-number="22"><span class="co">#enable mod_rewrite</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23"><span class="ex">a2enmod</span> rewrite</a></code></pre></div>
<p>In the next part we will reach forward to install php and mysql. You already learned the main functionalities, which we need to get our dev-env running. From now on it gets far more repetitive, but some small challenges are still waiting on our way. <a href="../posts/creating-your-own-php-dev-env-in-vagrant-part-3.html">Go to Part 3</a></p>
    </section>
</article>

          </main>
          <footer>
            <nav>
                <a href="../impressum.html" title="Impressum">Impressum</a>
                <a href="../datenschutz.html" title="Datenschutz">Datenschutz</a>
            </nav>
          </footer>
    </body>
</html>
